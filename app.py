import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
import pandas as pd
from docx import Document
from openai import OpenAI
import io

# 1. –î–æ–±–∞–≤–∏–º —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü –≤ Word (–≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞ –∫ –æ—Å—Ç–∞–ª—å–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏—è–º)
def add_table_from_markdown(doc, markdown_text):
    """–ü–∞—Ä—Å–∏—Ç Markdown —Ç–∞–±–ª–∏—Ü—ã –æ—Ç –ò–ò –∏ —Å–æ–∑–¥–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –≤ Word"""
    lines = [line.strip() for line in markdown_text.split('\n') if '|' in line]
    if len(lines) < 3: return # –ù–µ —Ç–∞–±–ª–∏—Ü–∞
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∏ –¥–∞–Ω–Ω—ã–µ
    headers = [cell.strip() for cell in lines[0].split('|') if cell.strip()]
    table = doc.add_table(rows=1, cols=len(headers))
    table.style = 'Table Grid'
    hdr_cells = table.rows[0].cells
    for i, h in enumerate(headers):
        hdr_cells[i].text = h
        
    for line in lines[2:]:
        cells = [cell.strip() for cell in line.split('|') if cell.strip()]
        if len(cells) == len(headers):
            row_cells = table.add_row().cells
            for i, c in enumerate(cells):
                row_cells[i].text = c

# 2. –û–°–ù–û–í–ù–û–ô –ë–õ–û–ö –ì–ï–ù–ï–†–ê–¶–ò–ò (–≤–Ω—É—Ç—Ä–∏ if uploaded_file:)
with st.form("interview"):
    st.subheader("üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è –Ω–∞–ø–æ–ª–Ω–µ–Ω–∏—è –æ—Ç—á–µ—Ç–∞")
    col1, col2 = st.columns(2)
    with col1:
        q1 = st.text_input("–ò—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (—Ü–∏—Ñ—Ä–æ–π)", placeholder="–ù–∞–ø—Ä: 80")
    with col2:
        q2 = st.text_input("–†–µ–∫–≤–∏–∑–∏—Ç—ã –ø–∏—Å—å–º–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è", placeholder="–ù–∞–ø—Ä: ‚Ññ123 –æ—Ç 01.12.25")
    
    # –°–ê–ú–û–ï –í–ê–ñ–ù–û–ï: –ü–æ–ª–µ –¥–ª—è "–º–µ–ª–æ—á–µ–π"
    additional_facts = st.text_area(
        "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ–∞–∫—Ç—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (–¥–ª—è –ø–æ–ª–Ω–æ—Ç—ã)", 
        help="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –¥–∞—Ç—ã –∑–∞–µ–∑–¥–æ–≤, –∞–¥—Ä–µ—Å–∞ —Å–±–æ—Ä–∞, –º–∞—Ä–∫–∏ –º–∞—à–∏–Ω –∏–ª–∏ –º–µ–Ω—é. –ò–ò —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç —ç—Ç–æ –ø–æ —Ä–∞–∑–¥–µ–ª–∞–º.",
        placeholder="–ù–∞–ø—Ä: 2 –≥—Ä—É–ø–ø—ã –ø–æ 40 —á–µ–ª. –ó–∞–µ–∑–¥—ã 8-9 –∏ 10-11 –¥–µ–∫–∞–±—Ä—è. –°–±–æ—Ä –≤ –†–µ—É—Ç–æ–≤–µ –∏ –ë–∞–ª–∞—à–∏—Ö–µ. –ó–∞–≤—Ç—Ä–∞–∫: –∫–∞—à–∞ 200–≥..."
    )
    
    submitted = st.form_submit_button("üî• –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç")

    if submitted:
        with st.spinner("–°—Ç–∞—Ä—à–∏–π —é—Ä–∏—Å—Ç DeepSeek –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏ —Ñ–∞–∫—Ç—ã..."):
            
            # –°–ò–°–¢–ï–ú–ù–ê–Ø –£–°–¢–ê–ù–û–í–ö–ê (–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)
            system_instruction = """–¢—ã ‚Äî –≤–µ–¥—É—â–∏–π —é—Ä–∏—Å—Ç-–∞–Ω–∞–ª–∏—Ç–∏–∫. –¢–≤–æ—è –∑–∞–¥–∞—á–∞: –Ω–∞ –æ—Å–Ω–æ–≤–µ –ö–æ–Ω—Ç—Ä–∞–∫—Ç–∞ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô –û–¢–ß–ï–¢.
            –ü–†–ê–í–ò–õ–ê:
            1. –ü–†–ò–ù–¶–ò–ü –ó–ï–†–ö–ê–õ–ê: –û–ø–∏—à–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ö–ê–ñ–î–û–ì–û —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–∑ –¢–ó. –ï—Å–ª–∏ –≤ –¢–ó —É–∫–∞–∑–∞–Ω—ã –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Å–æ—Å—Ç–∞–≤ –ø–∏—Ç–∞–Ω–∏—è ‚Äî –ø–µ—Ä–µ–Ω–µ—Å–∏ –∏—Ö –≤ –æ—Ç—á–µ—Ç –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ.
            2. –¢–†–ê–ù–°–§–û–†–ú–ê–¶–ò–Ø: –ö–æ–Ω—Ç—Ä–∞–∫—Ç "–¥–æ–ª–∂–µ–Ω" -> –û—Ç—á–µ—Ç "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º –æ–±–µ—Å–ø–µ—á–µ–Ω–æ/–≤—ã–ø–æ–ª–Ω–µ–Ω–æ".
            3. –¢–ê–ë–õ–ò–¶–´: –ï—Å–ª–∏ –≤ –¢–ó –µ—Å—Ç—å —Å–ø–∏—Å–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –º–µ–Ω—é –∏–ª–∏ –≥—Ä–∞—Ñ–∏–∫–∏ ‚Äî –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –æ—Ñ–æ—Ä–º–ª—è–π –∏—Ö –≤ –≤–∏–¥–µ Markdown-—Ç–∞–±–ª–∏—Ü.
            4. –ü–û–õ–ù–û–¢–ê: –ù–µ —Å–æ–∫—Ä–∞—â–∞–π! –ò—Å–ø–æ–ª—å–∑—É–π —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ç–µ—Ä–º–∏–Ω—ã, –ì–û–°–¢—ã –∏ –°–∞–Ω–ü–∏–ù—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞.
            5. –°–¢–†–£–ö–¢–£–†–ê: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ -> –ü—Ä–µ–¥–º–µ—Ç -> –°—Ä–æ–∫–∏ -> –û–±—ä–µ–º -> –°–æ–¥–µ—Ä–∂–∞—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å (–ø–æ —Ä–∞–∑–¥–µ–ª–∞–º –¢–ó) -> –ö–∞—á–µ—Å—Ç–≤–æ (–ì–û–°–¢—ã) -> –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è."""

            # –¢–ï–ö–°–¢ –ó–ê–ü–†–û–°–ê
            prompt_text = f"""
            –ö–û–ù–¢–†–ê–ö–¢ (–¢–ó): {contract_text[:5000]}
            
            –§–ê–ö–¢–´ –ò–ó –ò–ù–¢–ï–†–í–¨–Æ: 
            - –£—á–∞—Å—Ç–Ω–∏–∫–æ–≤: {q1}
            - –ü–∏—Å—å–º–æ: {q2}
            - –î–æ–ø. –¥–µ—Ç–∞–ª–∏: {additional_facts}
            
            –ó–ê–î–ê–ù–ò–ï: –ù–∞–ø–∏—à–∏ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—Ç—á–µ—Ç–∞. –î–ª—è —Ä–∞–∑–¥–µ–ª–æ–≤ —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ (–¢–µ—Ö–Ω–∏–∫–∞, –ü–∏—Ç–∞–Ω–∏–µ, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç) –∏—Å–ø–æ–ª—å–∑—É–π —Ç–∞–±–ª–∏—Ü—ã."""

            try:
                res = client_ai.chat.completions.create(
                    model="deepseek-chat",
                    messages=[
                        {"role": "system", "content": system_instruction},
                        {"role": "user", "content": prompt_text}
                    ]
                )
                
                report_content = res.choices[0].message.content
                
                # –°–û–ó–î–ê–ù–ò–ï –î–û–ö–£–ú–ï–ù–¢–ê
                out_doc = Document()
                # –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –±–ª–æ–∫–∏, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ —Ç–∞–±–ª–∏—Ü—ã
                blocks = report_content.split('\n\n')
                
                for block in blocks:
                    if '|' in block and '-|-' in block: # –≠—Ç–æ —Ç–∞–±–ª–∏—Ü–∞
                        add_table_from_markdown(out_doc, block)
                    else:
                        if block.startswith('#'): # –≠—Ç–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫
                            out_doc.add_heading(block.replace('#', '').strip(), level=2)
                        else:
                            out_doc.add_paragraph(block)
                
                buffer = io.BytesIO()
                out_doc.save(buffer)
                st.session_state['report_buffer'] = buffer.getvalue()
                st.success("–û—Ç—á–µ—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω —Å —É—á–µ—Ç–æ–º –≤—Å–µ—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –¥–µ—Ç–∞–ª–µ–π!")

            except Exception as e:
                st.error(f"–û—à–∏–±–∫–∞ –ò–ò: {e}")

# –ö–ù–û–ü–ö–ê –°–ö–ê–ß–ò–í–ê–ù–ò–Ø (–í–ù–ï –§–û–†–ú–´)
if 'report_buffer' in st.session_state:
    st.download_button("üì• –°–∫–∞—á–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π –û—Ç—á–µ—Ç (.docx)", st.session_state['report_buffer'], "Final_Report.docx")
