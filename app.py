import streamlit as st
import gspread
from google.oauth2.service_account import Credentials
# ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∏–º–ø–æ—Ä—Ç—ã —Ç–µ –∂–µ ...

# --- –ó–ê–ì–†–£–ó–ö–ê –°–ï–ö–†–ï–¢–û–í (–î–ª—è –ø—É–±–ª–∏—á–Ω–æ–π –≤–µ—Ä—Å–∏–∏) ---
# –ù–∞ Streamlit Cloud –º—ã –ø—Ä–æ–ø–∏—à–µ–º —ç—Ç–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
try:
    creds_dict = st.secrets["gcp_service_account"]
    creds = Credentials.from_service_account_info(creds_dict, 
        scopes=['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive'])
    gc = gspread.authorize(creds)
    
    DEEPSEEK_API_KEY = st.secrets["DEEPSEEK_API_KEY"]
    SHEET_ID = st.secrets["SHEET_ID"]
except Exception as e:
    st.error("–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ Cloud Console.")
    st.stop()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ—Å—Ç—É–ø–∞ (—É–∫–∞–∂–∏—Ç–µ –∏–º—è –≤–∞—à–µ–≥–æ JSON —Ñ–∞–π–ª–∞)
SERVICE_ACCOUNT_FILE = 'report_generator_key.json' 
SCOPES = ['https://www.googleapis.com/auth/spreadsheets', 'https://www.googleapis.com/auth/drive']

def get_gspread_client():
    creds = Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=SCOPES)
    return gspread.authorize(creds)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–º–µ–Ω—ã –≤—Ä–µ–º–µ–Ω–∏ (–ª–æ–≥–∏—á–µ—Å–∫–æ–µ —è–¥—Ä–æ)
def transform_to_past_tense(text):
    # –ó–¥–µ—Å—å –º—ã –±—É–¥–µ–º –≤—ã–∑—ã–≤–∞—Ç—å LLM —Å —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º: 
    # "–ü–µ—Ä–µ–≤–µ–¥–∏ –≤—Å–µ –≥–ª–∞–≥–æ–ª—ã –∏–∑ –±—É–¥—É—â–µ–≥–æ/–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –≤ –ø—Ä–æ—à–µ–¥—à–µ–µ/—Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ"
    # –ü–æ–∫–∞ —ç—Ç–æ –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ª–æ–≥–∏–∫–∏
    return text.replace("–¥–æ–ª–∂–µ–Ω –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞—Ç—å", "–æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–ª").replace("–æ–±—è–∑—É–µ—Ç—Å—è", "–≤—ã–ø–æ–ª–Ω–∏–ª")

st.title("ü§ñ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –æ—Ç—á–µ—Ç–æ–≤ –ø–æ —ç—Ç–∞–ª–æ–Ω–∞–º")

# 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
try:
    client = get_gspread_client()
    # –£–∫–∞–∂–∏—Ç–µ —Ç–æ—á–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–π —Ç–∞–±–ª–∏—Ü—ã
    sheet = client.open_by_key("1OHtHW48Yg19ZtIHITmRZeKg6vCuRkMjlRMTg5X6i4Lw").sheet1
    # –ß–∏—Ç–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
    raw_data = sheet.get_all_records()
    
    if not raw_data:
        st.error("–í —Ç–∞–±–ª–∏—Ü–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö! –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–ø–æ–ª–Ω–∏–ª –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É.")
    else:
        data = pd.DataFrame(raw_data)
        st.success("–ë–∞–∑–∞ —ç—Ç–∞–ª–æ–Ω–æ–≤ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∞!")
        st.write("–ù–∞–π–¥–µ–Ω–æ —ç—Ç–∞–ª–æ–Ω–æ–≤:", len(data))
except Exception as e:
    st.error(f"–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: {e}")

# 2. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤–æ–≥–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–æ–≤—ã–π –ö–æ–Ω—Ç—Ä–∞–∫—Ç (PDF/DOCX)", type=["pdf", "docx"])

if uploaded_file:
    st.info("–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é –∫–æ–Ω—Ç—Ä–∞–∫—Ç –∏ –∏—â—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è —Å —ç—Ç–∞–ª–æ–Ω–∞–º–∏...")
    
    # –ò–º–∏—Ç–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ –ø–æ —Ç—Ä–∏–≥–≥–µ—Ä–∞–º (–≤ –±—É–¥—É—â–µ–º –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É)
    # –°–µ–π—á–∞—Å –¥–ª—è —Ç–µ—Å—Ç–∞ –≤—ã–±–µ—Ä–µ–º –Ω–∞—à –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ª–æ–Ω
    selected_etalon = data.iloc[0] 
    
    st.write(f"### –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ç–∏–ø –ø—Ä–æ–µ–∫—Ç–∞: {selected_etalon['–¢–∏–ø –ø—Ä–æ–µ–∫—Ç–∞']}")
    st.write(f"**–û–ø–∏—Å–∞–Ω–∏–µ:** {selected_etalon['–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ']}")
    
    # 3. –ë–ª–æ–∫ –ò–Ω—Ç–µ—Ä–≤—å—é (–±–µ—Ä–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏–∑ —ç—Ç–∞–ª–æ–Ω–∞)
    st.subheader("üìù –£—Ç–æ—á–Ω–µ–Ω–∏–µ –¥–µ—Ç–∞–ª–µ–π –¥–ª—è –æ—Ç—á–µ—Ç–∞")
    with st.form("interview_form"):
        # –í —Ä–µ–∞–ª—å–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –º—ã —Ä–∞—Å–ø–∞—Ä—Å–∏–º —Ñ–∞–π–ª –ø–æ —Å—Å—ã–ª–∫–µ –∏ –≤—ã—Ç–∞—â–∏–º –≤–æ–ø—Ä–æ—Å—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        q1 = st.number_input("–ö–∞–∫–æ–µ –∏—Ç–æ–≥–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –±—ã–ª–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ?")
        q2 = st.text_input("–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∏ –¥–∞—Ç—É –ø–∏—Å—å–º–∞ —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏—è –º–∞–∫–µ—Ç–æ–≤")
        submit = st.form_submit_button("–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫ –æ—Ç—á–µ—Ç–∞")
        
        if submit:
            st.warning("–ì–µ–Ω–µ—Ä–∏—Ä—É—é —Ç–µ–∫—Å—Ç –≤ –ø—Ä–æ—à–µ–¥—à–µ–º –≤—Ä–µ–º–µ–Ω–∏...")
            # –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –º–∞–≥–∏—è —Å–±–æ—Ä–∫–∏
            result = f"–°–æ–≥–ª–∞—Å–Ω–æ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º –æ—Ä–≥–∞–Ω–∏–∑–æ–≤–∞–Ω —Ñ–æ—Ä—É–º. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ {q1} —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–∏–µ –º–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ –ø–∏—Å—å–º–æ–º {q2}."
            st.success("–ì–æ—Ç–æ–≤—ã–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç –æ—Ç—á–µ—Ç–∞:")
            st.text_area("–†–µ–∑—É–ª—å—Ç–∞—Ç:", result, height=200)